FROM node:22-alpine

WORKDIR /app

# Create and set ownership of node_modules directory
RUN mkdir -p /app/node_modules && chown -R node:node /app

# Set up persistent storage for backend
ENV STORAGE_BASE=/var/lib/analysis-server

# Create volume directories with proper permissions
RUN mkdir -p /var/lib/analysis-server/analyses \
    /var/lib/analysis-server/config \
    && chown -R node:node /var/lib/analysis-server

# Switch to non-root user
USER node

# Copy workspace files with correct ownership
COPY --chown=node:node package*.json ./
COPY --chown=node:node frontend/package.json ./frontend/
COPY --chown=node:node backend/package.json ./backend/

# Install dependencies as non-root user
RUN npm install

# Copy source code with correct ownership
COPY --chown=node:node . .

# Expose ports for both services
EXPOSE 5173 3000

# Use the root level dev script that starts both services
CMD ["npm", "run", "dev"]